---
layout: post
title:  "Sessions"
date:   2016-10-18 16:26:00 +0000
tags: ['Zookeeper']
author: "AngJoong"
description: "세션 설정과 상태 "
---

주키퍼 클라이언트는 바인딩 언어를 사용하여 서비스에 대한 핸들을 생성함으로써 주키퍼 서비스와의 세션을 설정한다. 일단 **CONNECTING** 상태에서 핸들을 시작하고 클라이언트 라이브러리는 주키퍼 서비스의 서버들중 하나에 연결하기 위해 시도하고 이 시점에 **CONNECTED** 상태로 전환된다. 정상 동작 동안에는 이 두 상태중 하나의 상태이다. 만약 세션 만료, 인증 실패와 같은 회복할 수 없는 에러가 발생하거나 애플리케이션이 명식적으로 핸들을 닫아 버린다면 핸들은 **CLOSED** 상태가 된다.  

###### 주키퍼 클라이언트 세션 변화
![](https://zookeeper.apache.org/doc/trunk/images/state_dia.jpg)

세션을 생성하기 위해 애플리케이션 코드는 반드시 각 주키퍼 서버에 일치하는 연결 스트링을 제공해야 한다. `(e.g. "127.0.0.1:4545" or "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002")` 주키퍼 클라이언트 라이브러리는 임의의 서버를 선택해 연결을 시도한다. 만약 연결이 실패하거나 어떠한 이유로 서버로 부터 연결이 종료된다면 클라이언트는 연결이 될 때까지 자동적으로 리스트의 다음 서버로 연결을 시도한다.  

연결 스트링에 **chroot** 정보를 추가 할 수 있다. `(e.g. 127.0.0.1:4545/app/a" or "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a)` chroot를 추가하게 클라이언트의 네임스페이스 루트를 변경 할 수 있다.  

클라이언트가 주키퍼 서비스의 핸들을 얻을때, 주키퍼는 세션을 생성해 클라이언트에 할당한다. 만약 클라이언트가 다른 주키퍼 서버에 연결하면 클라이언트는 연결 핸드쉐이크(Connection Handshake)의 일부로 세션 아이디를 전송한다. 보안을 위해 서버는 어떤 서버에서도 검증할 수 있는 세션아이디를 위한 패스워드를 생성한다. 패스워드는 클라이언트가 세션을 설정할때 세션 아이디와 함께 보내진다. 클라이언트는 새로운 서버와 세션을 재설정할때마다 세션아이디와 함께 패스워드를 보낸다.

주키퍼 세션을 생성하기 위해 주키퍼 클라이언트 라이브러리에 보내는 파라메터중 하나는 세션 타임아웃이다. 클라이언트가 요청 타임아웃을 보내면 서버는 클라이언트에세 보낼 수 있는 타임아웃과 함에 응답한다. 타임아웃은 틱타임 기준 2 ~ 20 사이에서 지정할 수 있다.

클라이언트가 주키퍼 클러스터와 연결이 분리되면 세션생성시 사용한 연결 스트링에서 서버 목록을 검색한다. 클라이언트가 서버중 한대와 재연결되면 세션 상태는 "CONNECTED"가 되거나 "EXPIRED" 상태가 된다. (세션 타임아웃 여부에 따라) 연결이 끊어짐에 따라 새로운 새셩을 생성하는 것은 바람직하지 않다. 주키퍼 클라이언트 라이브러리가 재연결을 처리한다. 오직 세션이 만료되었을때만 새로운 세션을 생성해야 한다.

세션 만료는 주키퍼 클러스터에의해 관리된다. 주키퍼 클라이언트가 주키퍼 클러스터와 세션을 설정할때 타임아웃 값을 제공한다. 이 값은 클러스터가 언제 클라이언트의 세션을 만료시킬지 결정하는데 사용한다. 만료는 클러스터가 명시된 세션 타임아웃 기간 안에 클라이언트로부터 어떤 요청도 받지 못하면 발생한다. 세션 만료시 클러스터는 세션이 소유한 임시노드를 제거하고 그 노드를 워치하고 있는 클라이언트들에게 변경사항을 알린다. 이 시점에 만료된 세션의 클라이언트는 아직까지 연결이 끊겨있다. 클러스터와 재연결이 가능할때까지 세션 만료 통보를 받지 못한다. 클라이언트는 TCP 연결이 맺어질대 까지 DISCONNECTED 상태를 유지하고, TCP 연결이 맺어진 후에야 세션 만료 통보를 받는다.

1. connected: 세션이 설정되고 클라이언트가 클러스터와 통신한다.
2. 클라이언트가 클러스터와 분리된다.
3. disconnected: 클라이언트가 서버와의 연결을 잃는다.
4. 시간이 지나서, 타임아웃 기간 후 클러스터는 세션을 만료한다. 이때 클라이언트는 세션 만료에 대한 어떠한 정보도 알지 못한다.
5. 시간이 지나서, 클라이언트가 클러스터와 네트워크 레벨의 연결을 얻는다.
6. expired: 클라이언트는 클러스터에 다시 연결되고 세션이 만료되었다는 통보를 받는다.

주키퍼 세션 생성시 사용하는 다른 파라메터는 디폴트 왓쳐다(Watcher). 왓쳐는 클라이언트에서 어떤 상태 변화가 일어나면 통보를 받는다. 예를들어 만약 클라이언트가 서버와의 연결을 잃거나 클라이언트의 세션이 만료되면 알림을 받을 것이다.

클라이언트에 의해 보내진 요청에 의해 세션은 계속해서 유지된다. 만약 세션이 타임아웃될 시간 동안 유휴(Idle) 하다면, 클라이언트는 세션을 유지하기 위해 핑(Ping)을 보낼것이다. 핑요청은 서버에게 클라이언트가 아직 활성화 되어 있다고 알려줄 뿐만 아니라, 클라이언트에게도 서버와의 연결이 활성화 되어 있다는걸 검증할 수 있게 해준다. 핑의 타이밍은 죽은 연결을 탐지하고 새로운 서버와 재연결할 충분한 시간을 보장한다.  

일단 서버와 연결되면 언제 클라이언트 라이브러리가 커낵션손실을 발생시킬지 언제 동기 또는 비동기 작업이 수행될지 2가지 케이스가 있다.

1. 애플리케이션이 더이상 유효하지 않은 세션에 대한 작업을 호출한다.
2. 서버로 지연된 작업이 있을때 클라이언트는 서버와의 연결을 끊는다. (지연된 비동기 호출)

<br>
<br>
<br>
<br>
<br>

\#1. https://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkDataModel
