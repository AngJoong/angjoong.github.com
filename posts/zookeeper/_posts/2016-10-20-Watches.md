---
layout: post
title:  "Watches"
date:   2016-10-20 08:51:00 +0000
tags: ['Zookeeper']
author: "AngJoong"
description: ""
---

주키퍼에서 모든 읽기 작업`(getData(), getChildren(), exists())`은
부수효과로 워치 설정 옵션을 갖는다.

# 1. 워치의 정의(Zookeeper's definition of a Watch)
 워치는 워치가 설정된 데이터가 변경될때 워치를 설정한 클라이언트에 이벤트를 보내는 **일회성 트리거**이다. 아래는 워치의 3가지 핵심 포인트이다.  

## 1.1 일회성 트리거(One-time trigger)
하나의 워치 이벤트는 데이터가 변경되면 클라이언트에게 보내진다. 예를들어 클라이언트가 `getData("/znode1", true)`를 한 후 /znode1의 데이터가 변경되거나 제거 되면 클라이언트는 /znode1에 대한 워치 이벤트를 얻게 된다. 만약 /znode1이 다시 변경되더라도 클라이언트가 새로운 워치를 설정하는 또다른 읽기 작업을 수행하지 않는다면 워치 이벤트를 받을 수 없다.

## 1.2 클라이언트로의 전송(Sent to the client)
이 사실은 이벤트가 클라이언트로 전송된다는걸 의미하지만, 변경 작업에 대한 성공 코드가 변경작업을 수행한 클라이언트에 도착하기 전에 이벤트가 도착하지 않을 수도 있다.

워치는 워쳐(Watcher)에게 비동기로 보내진다.

주키퍼는 순서를 보장한다.: 클라이언트는 클라이언트가 처음으로 워치 이벤트를 볼때가지 설정한 워치의 변경을 보지 못한다.
네트워크 지연이나 다른 요소때문에 다른 시간에 업데이트로 부터 리턴 코드를 받고 워치를 볼수 있다. 핵심은 다른 클라이언트에게 보여지는 모든것은 일관된 순서를 갖는다는 것이다.

## 1.3 워치 설정을 위한 데이터
이것은 노드가 변경될 수 있는 다른 방법을 참고한다. 이것은 주키퍼가 워치들을 두가지 목록으로 유지하는것을 돕는다. 데이터 워치와 차일드 워치이다. getDate(), exists() - 데이터 워치, getChildren() - 차일드 워치. 반환된 데이터의 종류에 따라 설정되어 있는 워치를 알 수 있다. getData(), exists()는 노드의 데이터에 대한 정보를 반환한다. 반면에 getChildren()은 차일드의 리스트를 반환한다. 따라서, setData()는 설정되어 있는 제트노드에 대한 데이터 워치를 실행할것이다. create()는 생성된 제트노드와 부모 제트노드에 대한 차일드 워치를 실행할 것이다. delete()는 제거 되는 제트노드의 데이터 워치, 차일드 워치 뿐만아니라 자식노드들에 대한 차일드 워치도 실행 시킨다.  

워치는 클라이언트가 연결된 주키퍼 서버에서 로컬관리 된다. 이것이 워치 설정을 가볍게 하고 관리, 전파하게 한다. 클라이언트가 새로운 서버에 접속하면 어떤 세션 이벤트를 위해 워치는 트리거될것읻. 워치는 서버와 접속이 끊긴 상태에서는 받을 수 없다. 클라이언트가 재연결되면 이전에 등록되었던 워치들이 재 등록되고 트리거 되야할 워치들은 트리거 된다.

## 1.4 워치의 의미(Semantics of Watches)
주키퍼 상태를 읽는 세가지 함수를 통해 워치를 설정할 수 있다. 다음 리스트는 워치가 실행 할 수 있는 이벤트와 이벤트를 사용하는 함수이다.

###### 워치 이벤트 활성화 함수
| call \ event|create|delete|changed|child|
|:---:|:---:|:---:|:---:|:---:|
|exists()|O|O|O|X|
|getData()|X|O|O|X|
|getChildren()|X|O|X|O|

## 1.5 워치 제거(Remove Watches)
removeWatches()를 호출해 제트노드에 등록된 워치를 제거할 수 있다. 또한, 로컬 플래그를 true로 설정함으로써 서버가 없더라도 주키퍼 클라이언트는 워치를 지역적으로 제거할 수 있다. 워치가 성공적으로 제거 된후 다음 리스트의 이벤트들이 실행될 것이다.

| Data Remove | Child Remove |
|:---:|:---:|
|exists() or getData()<br>호출로 추가된 왓쳐|getChildren()<br>호출로 추가된 와쳐|

## 1.6 와치의 보장성(What Zookeeper Guarantees about Watches)


<br>
<br>
<br>
<br>
<br>

\#1. https://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkWatches
